<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHACL Editor for I14Y - Web Version</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
    
    <!-- Custom CSS for D3.js diagram styling -->
    <style>
        /* D3.js element styling */
        .node circle {
            stroke-width: 2px;
        }
        
        .node text {
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        
        /* Connection mode styling */
        .source-node circle {
            stroke: #ff9900 !important;
            stroke-width: 3px !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { stroke-width: 3px; }
            50% { stroke-width: 5px; }
            100% { stroke-width: 3px; }
        }
        
        #connection-status.active {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        /* Multi-select styling */
        #connect-selected-btn {
            animation: highlight-button 2s infinite;
        }
        
        @keyframes highlight-button {
            0% { background-color: #28a745; }
            50% { background-color: #218838; }
            100% { background-color: #28a745; }
        }
        
        #selection-status {
            background-color: #e2f0ff !important;
            border: 1px solid #b8daff !important;
        }
        
        /* Layout switch styling */
        .form-switch .form-check-input {
            width: 2.5em;
            cursor: pointer;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        /* Identifier validation styling */
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Full-width Header -->
    <header class="app-header">
        <div class="container-fluid bg-light">
            <div class="row">
                <div class="col-12 py-3 text-center">
                    <h1 class="mb-0">I14Y Data Structure Editor</h1>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container-fluid main-container">
        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-md-2 sidebar">
                
                <!-- Add Elements -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Add Elements</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-class btn-sm w-100 mb-2" onclick="showAddClassModal()">Class</button>
                        <button class="btn btn-data-element btn-sm w-100 mb-2" onclick="showAddDataElementModal()">Data Element</button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Actions</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="removeSelected()">Delete Node</button>
                        <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="toggleConnectionMode()" id="connect-btn">Connect Mode</button>
                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="connectSelectedNodes()" id="connect-selected-btn" style="display: none;">Connect Selected Nodes</button>
                        <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="detachSelected()" id="detach-btn" style="display: none;">Detach</button>
                        <div id="connection-status" class="connection-mode" style="display: none;">
                            <small>Select source node to start connection</small>
                        </div>
                        <div id="selection-status" style="display: none; margin-bottom: 10px; padding: 5px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #ddd;">
                            <small>No nodes selected</small>
                        </div>
                        <div id="edge-status" style="display: none;">
                            <small>Connection selected - click Detach to remove</small>
                        </div>
                        <small class="text-muted d-block mt-2">Tip: Hold Shift to select multiple nodes</small>
                    </div>
                </div>

                <!-- Export -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Import & Export</h6>
                    </div>
                    <div class="card-body">
                        <!-- New Structure Button -->
                        <div class="mb-3">
                            <button class="btn btn-new-structure btn-sm w-100" onclick="createNewStructure()">New Structure</button>
                        </div>
                        
                        <!-- TTL Import/Export -->
                        <div class="d-flex gap-2 mb-2">
                            <input type="file" id="ttl-file" accept=".ttl" style="display: none;" onchange="importTTL(this)">
                            <button class="btn btn-outline-dark btn-sm flex-fill" onclick="document.getElementById('ttl-file').click()">Import TTL</button>
                            <button class="btn btn-outline-dark btn-sm flex-fill" onclick="exportTTL()">Export TTL</button>
                        </div>
                        
                        <!-- CSV Import -->
                        <div class="mb-2">
                            <input type="file" id="csv-file" accept=".csv" style="display: none;" onchange="showCSVImportModal(this)">
                            <button class="btn btn-outline-dark btn-sm w-100" onclick="document.getElementById('csv-file').click()">Import CSV</button>
                        </div>
                        
                        <!-- XSD Import -->
                        <div class="mb-3">
                            <input type="file" id="xsd-file" accept=".xsd" style="display: none;" onchange="showXSDImportModal(this)">
                            <button class="btn btn-outline-dark btn-sm w-100" onclick="document.getElementById('xsd-file').click()">Import XSD</button>
                        </div>
                        
                        <!-- Project -->
                        <div>
                            <strong class="small">Project:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <input type="file" id="project-file" accept=".json" style="display: none;" onchange="loadProject(this)">
                                <button class="btn btn-outline-dark btn-sm flex-fill" onclick="document.getElementById('project-file').click()">Load</button>
                                <button class="btn btn-outline-dark btn-sm flex-fill" onclick="saveProject()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Graph Area -->
            <div class="col-md-7">
                <div class="main-content">
                    <!-- Visualization Type Switcher -->
                    <div class="mb-2 d-flex align-items-center justify-content-between" style="padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div class="d-flex align-items-center">
                            <label class="form-label mb-0 me-2 small" style="font-weight: 500;">Visualization:</label>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Visualization type">
                                <input type="radio" class="btn-check" name="viz-type" id="viz-network" autocomplete="off" checked onchange="switchVisualization('network')">
                                <label class="btn btn-outline-primary" for="viz-network">Network</label>
                                
                                <input type="radio" class="btn-check" name="viz-type" id="viz-tree" autocomplete="off" onchange="switchVisualization('tree')">
                                <label class="btn btn-outline-primary" for="viz-tree">Tree View</label>
                            </div>
                        </div>
                        <small class="text-muted" id="viz-description">Force-directed network layout</small>
                    </div>
                    
                    <div id="graph-container">
                        <!-- Debug info will be added here -->
                        <div id="debug-info" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border: 1px solid #ccc; z-index: 1000; max-width: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Node Information -->
            <div class="col-md-3 right-sidebar">
                <div id="selected-node-section" style="display: none;">
                    <h5 class="mb-3">Information</h5>
                    
                    <!-- Node Information -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div id="selected-node-info"></div>
                        </div>
                    </div>

                    <!-- Order Field (for data elements) -->
                    <div class="card mb-3" id="order-section" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Display Order</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">Set the order for this data element in the TTL export. Lower numbers appear first.</p>
                            <label class="form-label small">Order:</label>
                            <input type="number" class="form-control form-control-sm mb-2" id="element-order" placeholder="e.g., 1, 2, 3..." min="0">
                            <button class="btn btn-outline-dark btn-sm w-100" onclick="applyOrder()">Apply Order</button>
                        </div>
                    </div>

                    <!-- SHACL Constraints -->
                    <div class="card mb-3" id="constraints-section">
                        <div class="card-header">
                            <h6 class="mb-0">SHACL Constraints</h6>
                            <div id="i14y-constraints-info" class="alert alert-info alert-sm mt-2" style="display: none; padding: 0.5rem; margin-bottom: 0;">
                                <small><i class="bi bi-info-circle"></i> Constraints automatically applied from I14Y</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="constraint-group mb-3" id="length-group">
                                <h6 class="small">Length</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Min Length:</label>
                                        <input type="number" class="form-control form-control-sm" id="min-length">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Max Length:</label>
                                        <input type="number" class="form-control form-control-sm" id="max-length">
                                    </div>
                                </div>
                            </div>

                            <div class="constraint-group mb-3" id="pattern-group">
                                <h6 class="small">Pattern</h6>
                                <input type="text" class="form-control form-control-sm" id="pattern" placeholder="Regex pattern">
                            </div>

                            <div class="constraint-group mb-3" id="enumeration-group">
                                <h6 class="small">Enumeration</h6>
                                <input type="text" class="form-control form-control-sm" id="in-values" placeholder="Comma-separated values">
                            </div>

                            <div class="constraint-group mb-3" id="references-group">
                                <h6 class="small">References</h6>
                                <div class="mb-2" id="datatype-field">
                                    <label class="form-label small">Datatype:</label>
                                    <input type="text" class="form-control form-control-sm" id="datatype" placeholder="e.g., xsd:string, xsd:decimal" readonly>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">Node Reference:</label>
                                    <input type="text" class="form-control form-control-sm" id="node-reference">
                                </div>
                                <div>
                                    <label class="form-label small">Range:</label>
                                    <input type="text" class="form-control form-control-sm" id="range">
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-dark btn-sm flex-fill" onclick="applyConstraints()">Apply</button>
                                <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearConstraints()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder when no node selected -->
                <div id="no-node-selected" class="text-center text-muted">
                    <p>Select a node to view details and configure constraints</p>
                </div>
                
                <!-- Edge Information (shown when an edge is selected) -->
                <div id="selected-edge-section" style="display: none;">
                    <h5 class="mb-3">Connection Information</h5>
                    
                    <!-- Edge Information -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div id="selected-edge-info"></div>
                        </div>
                    </div>

                    <!-- Cardinality Configuration -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Cardinality</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="edge-cardinality" class="form-label small">Cardinality:</label>
                                <select class="form-select form-select-sm" id="edge-cardinality">
                                    <option value="0..1">0..1 (Optional, at most one)</option>
                                    <option value="1..1">1..1 (Exactly one)</option>
                                    <option value="0..n">0..n (Zero or more)</option>
                                    <option value="1..n">1..n (One or more)</option>
                                    <option value="0..0">0..0 (Forbidden)</option>
                                    <option value="2..5">2..5 (Custom range)</option>
                                </select>
                            </div>
                            <div class="mb-3" id="custom-cardinality-section" style="display: none;">
                                <label for="custom-cardinality" class="form-label small">Custom Cardinality:</label>
                                <input type="text" class="form-control form-control-sm" id="custom-cardinality" placeholder="e.g., 2..10, 5..*, 3..3">
                                <div class="form-text">Format: min..max (use * for unlimited)</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-dark btn-sm flex-fill" onclick="applyEdgeCardinality()">Apply</button>
                                <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearEdgeSelection()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Data Element Modal -->
    <div class="modal fade" id="addDataElementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Data Element</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title (Multilingual):</label>
                        <ul class="nav nav-tabs" id="data-element-title-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="data-element-de-tab" data-bs-toggle="tab" data-bs-target="#data-element-de-title" type="button" role="tab" aria-controls="data-element-de-title" aria-selected="true">DE</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="data-element-fr-tab" data-bs-toggle="tab" data-bs-target="#data-element-fr-title" type="button" role="tab" aria-controls="data-element-fr-title" aria-selected="false">FR</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="data-element-it-tab" data-bs-toggle="tab" data-bs-target="#data-element-it-title" type="button" role="tab" aria-controls="data-element-it-title" aria-selected="false">IT</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="data-element-en-tab" data-bs-toggle="tab" data-bs-target="#data-element-en-title" type="button" role="tab" aria-controls="data-element-en-title" aria-selected="false">EN</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="data-element-title-tab-content">
                            <div class="tab-pane fade show active" id="data-element-de-title" role="tabpanel" aria-labelledby="data-element-de-tab">
                                <input type="text" class="form-control mt-2" id="data-element-title-de" required 
                                       placeholder="German title">
                            </div>
                            <div class="tab-pane fade" id="data-element-fr-title" role="tabpanel" aria-labelledby="data-element-fr-tab">
                                <input type="text" class="form-control mt-2" id="data-element-title-fr" 
                                       placeholder="French title">
                            </div>
                            <div class="tab-pane fade" id="data-element-it-title" role="tabpanel" aria-labelledby="data-element-it-tab">
                                <input type="text" class="form-control mt-2" id="data-element-title-it" 
                                       placeholder="Italian title">
                            </div>
                            <div class="tab-pane fade" id="data-element-en-title" role="tabpanel" aria-labelledby="data-element-en-tab">
                                <input type="text" class="form-control mt-2" id="data-element-title-en" 
                                       placeholder="English title">
                            </div>
                        </div>
                        <div class="form-text">The title used for this data element in different languages</div>
                    </div>
                    <div class="mb-3">
                        <label for="data-element-description" class="form-label">Description:</label>
                        <textarea class="form-control" id="data-element-description" rows="3"
                                  placeholder="Description of this data element"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link to I14Y Concept (optional):</label>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="data-element-concept-search" 
                                   placeholder="Search I14Y concepts...">
                            <button type="button" class="btn btn-outline-primary" onclick="searchConceptsForDataElement()">Search</button>
                        </div>
                        <div id="data-element-concept-results" class="mt-2" style="display: none;">
                            <!-- Concept search results will appear here -->
                        </div>
                        <div id="data-element-selected-concept" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Selected Concept:</strong> <span id="selected-concept-name"></span><br>
                                <small class="text-muted"><span id="selected-concept-publisher"></span></small><br>
                                <small class="text-muted">ID: <span id="selected-concept-id"></span></small>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSelectedConcept()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addDataElement()">Add Data Element</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="class-title" class="form-label">Title:</label>
                        <input type="text" class="form-control" id="class-title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Multilingual):</label>
                        <ul class="nav nav-tabs" id="class-description-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="class-de-tab" data-bs-toggle="tab" data-bs-target="#class-de-description" type="button" role="tab" aria-controls="class-de-description" aria-selected="true">DE</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="class-fr-tab" data-bs-toggle="tab" data-bs-target="#class-fr-description" type="button" role="tab" aria-controls="class-fr-description" aria-selected="false">FR</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="class-it-tab" data-bs-toggle="tab" data-bs-target="#class-it-description" type="button" role="tab" aria-controls="class-it-description" aria-selected="false">IT</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="class-en-tab" data-bs-toggle="tab" data-bs-target="#class-en-description" type="button" role="tab" aria-controls="class-en-description" aria-selected="false">EN</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="class-description-tab-content">
                            <div class="tab-pane fade show active" id="class-de-description" role="tabpanel" aria-labelledby="class-de-tab">
                                <textarea class="form-control mt-2" id="class-description-de" rows="3" placeholder="German description"></textarea>
                            </div>
                            <div class="tab-pane fade" id="class-fr-description" role="tabpanel" aria-labelledby="class-fr-tab">
                                <textarea class="form-control mt-2" id="class-description-fr" rows="3" placeholder="French description"></textarea>
                            </div>
                            <div class="tab-pane fade" id="class-it-description" role="tabpanel" aria-labelledby="class-it-tab">
                                <textarea class="form-control mt-2" id="class-description-it" rows="3" placeholder="Italian description"></textarea>
                            </div>
                            <div class="tab-pane fade" id="class-en-description" role="tabpanel" aria-labelledby="class-en-tab">
                                <textarea class="form-control mt-2" id="class-description-en" rows="3" placeholder="English description"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addClass()">Add Class</button>
                </div>
            </div>
        </div>
    </div>

    <!-- I14Y Search Modal -->
    <div class="modal fade" id="i14ySearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Search I14Y Concepts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="i14y-search-query" placeholder="Search concepts...">
                            <button class="btn btn-outline-secondary" onclick="searchI14Y()">Search</button>
                        </div>
                    </div>
                    <div id="i14y-results" style="max-height: 400px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- I14Y Dataset Search Modal -->
    <div class="modal fade" id="i14yDatasetSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Search I14Y Datasets</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="i14y-dataset-search-query" placeholder="Search datasets...">
                            <button class="btn btn-outline-secondary" onclick="searchI14YDatasets()">Search</button>
                        </div>
                    </div>
                    <div id="i14y-dataset-results" style="max-height: 400px; overflow-y: auto;">
                        <!-- Dataset search results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Link to I14Y Concept Modal -->
    <div class="modal fade" id="linkToI14YModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Link Custom Concept to I14Y</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <small>
                            <strong>Note:</strong> Linking this concept to an I14Y concept will replace its properties with the official I14Y values.
                            Any custom constraints will be preserved.
                        </small>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="link-i14y-search-query" placeholder="Search I14Y concepts...">
                            <button class="btn btn-outline-secondary" onclick="searchForI14YLink()">Search</button>
                        </div>
                    </div>
                    <div id="link-i14y-results" style="max-height: 400px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal fade" id="csvImportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csv-dataset-name" class="form-label">Dataset Name:</label>
                        <input type="text" class="form-control" id="csv-dataset-name" value="Imported Dataset">
                        <div class="form-text">This will be the title of your dataset</div>
                    </div>
                    <div class="mb-3">
                        <label for="csv-lang" class="form-label">Default Language:</label>
                        <select class="form-select" id="csv-lang">
                            <option value="de">German (de)</option>
                            <option value="fr">French (fr)</option>
                            <option value="it">Italian (it)</option>
                            <option value="en">English (en)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Note:</strong> The CSV file will be analyzed to automatically detect column data types (text, numbers, dates, etc.).
                            Columns with "year" or similar keywords will be interpreted as dates.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importCSV()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- XSD Import Modal -->
    <div class="modal fade" id="xsdImportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import XSD</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="xsd-dataset-name" class="form-label">Dataset Name:</label>
                        <input type="text" class="form-control" id="xsd-dataset-name" value="Imported Dataset">
                        <div class="form-text">This will be the title of your dataset</div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Note:</strong> The XSD file will be converted to SHACL shapes.
                            Complex type definitions will be converted to class nodes, and simple types will be converted to concept nodes.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importXSD()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedNodeId = null;
        let selectedEdgeId = null;
        let currentVisualization = 'network'; // Track current visualization type
        // Variables connectionMode and pendingConnection are already defined in network-d3.js
        // Do not redeclare them here
        
        // Make currentVisualization globally accessible
        window.currentVisualization = currentVisualization;

        // Wrapper function to call the appropriate graph loading function
        function loadGraph() {
            if (window.currentVisualization === 'tree') {
                if (typeof window.loadXmlTree === 'function') {
                    window.loadXmlTree();
                }
            } else {
                if (typeof window._loadGraphWithD3Original === 'function') {
                    window._loadGraphWithD3Original();
                }
            }
        }
        
        // Make loadGraph globally accessible
        window.loadGraph = loadGraph;
        
        // Switch between visualization types
        function switchVisualization(vizType) {
            currentVisualization = vizType;
            window.currentVisualization = vizType; // Update global reference
            
            const vizDescription = document.getElementById('viz-description');
            
            if (vizType === 'tree') {
                // Initialize and switch to XML tree view
                if (typeof initializeXmlTreeVisualization === 'function') {
                    initializeXmlTreeVisualization('graph-container');
                    loadGraph();
                    vizDescription.textContent = 'Hierarchical tree layout';
                    
                    // Override toggleConnectionMode for tree view
                    window.toggleConnectionMode = window.toggleXmlTreeConnectionMode;
                } else {
                    console.error('XML tree visualization not available');
                }
            } else {
                // Switch to network view  
                if (typeof initializeD3Visualization === 'function') {
                    initializeD3Visualization('graph-container');
                    loadGraph();
                    vizDescription.textContent = 'Force-directed network layout';
                    
                    // Restore original network toggleConnectionMode
                    if (window._networkToggleConnectionMode) {
                        window.toggleConnectionMode = window._networkToggleConnectionMode;
                    }
                } else {
                    console.error('Network visualization not available');
                }
            }
        }
        
        // Test function to display nodes directly without D3.js
        function testDisplayNodes() {
            const debugEl = document.getElementById('debug-info');
            debugEl.innerHTML = '<div>Loading graph data...</div>';
            
            fetch('/api/graph')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    debugEl.innerHTML = '<div>Graph data received:</div>';
                    debugEl.innerHTML += `<div>Nodes: ${data.nodes.length}, Edges: ${data.edges.length}</div>`;
                    
                    // Create a simple HTML representation of nodes
                    const container = document.getElementById('graph-container');
                    container.innerHTML = '';
                    
                    // Create an SVG container
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('width', '100%');
                    svg.setAttribute('height', '500px');
                    svg.style.border = '1px solid #ccc';
                    svg.style.backgroundColor = '#f8f8f8';
                    container.appendChild(svg);
                    
                    // Place nodes evenly
                    const width = 800;
                    const height = 400;
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const radius = Math.min(width, height) / 3;
                    
                    data.nodes.forEach((node, index) => {
                        // Calculate position in a circle
                        const angle = (index / data.nodes.length) * 2 * Math.PI;
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        
                        // Create circle for node
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('r', '30');
                        
                        // Set color based on node type
                        let color = '#aaaaaa';
                        switch (node.type) {
                            case 'dataset': color = '#ffffcc'; break;
                            case 'class': color = '#e6f3ff'; break;
                            case 'data_element': color = '#f0f0f0'; break;
                            case 'concept': color = '#e6ffe6'; break;
                        }
                        
                        circle.setAttribute('fill', color);
                        circle.setAttribute('stroke', '#000');
                        circle.setAttribute('stroke-width', '2');
                        svg.appendChild(circle);
                        
                        // Add text label
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x);
                        text.setAttribute('y', y);
                        text.setAttribute('text-anchor', 'middle');
                        text.setAttribute('dominant-baseline', 'middle');
                        text.textContent = node.title;
                        svg.appendChild(text);
                        
                        // Add type label
                        const typeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        typeText.setAttribute('x', x);
                        typeText.setAttribute('y', y + 20);
                        typeText.setAttribute('text-anchor', 'middle');
                        typeText.setAttribute('font-size', '10px');
                        typeText.textContent = node.type;
                        svg.appendChild(typeText);
                    });
                    
                    // Add debug data
                    debugEl.innerHTML += '<div class="mt-2">Node data:</div>';
                    data.nodes.forEach(node => {
                        debugEl.innerHTML += `<div>${node.id}: ${node.title} (${node.type})</div>`;
                    });
                })
                .catch(error => {
                    debugEl.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                    console.error('Error fetching graph data:', error);
                });
        }
        
        // Make test function globally available
        window.testDisplayNodes = testDisplayNodes;
        
        // Define global handlers that network-d3.js will call
        window.selectNode = function(nodeId) {
            selectedNodeId = nodeId;
            window.selectedNodeId = selectedNodeId;  // Update global reference
            loadNodeDetails(nodeId);
            document.getElementById('selected-node-section').style.display = 'block';
            document.getElementById('selected-edge-section').style.display = 'none';
            document.getElementById('no-node-selected').style.display = 'none';
        }
        
        window.selectEdge = function(edgeId) {
            selectedEdgeId = edgeId;
            document.getElementById('selected-node-section').style.display = 'none';
            document.getElementById('selected-edge-section').style.display = 'block';
            document.getElementById('no-node-selected').style.display = 'none';
            document.getElementById('detach-btn').style.display = 'block';
            document.getElementById('edge-status').style.display = 'block';
            loadEdgeDetails(edgeId);
        }
        
        // Helper function to get text from multilingual objects
        function getMultilingualText(obj) {
            if (!obj) return '';
            if (typeof obj === 'string') return obj;
            return obj.de || obj.en || obj.fr || obj.it || obj.rm || Object.values(obj)[0] || '';
        }
        
        // Helper function to get language-specific text from multilingual objects
        function getLanguageText(obj, lang) {
            if (!obj) return '';
            if (typeof obj === 'string') return obj;
            return obj[lang] || '';
        }
        
        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Validation function for identifier fields
        function validateIdentifier(input) {
            const value = input.value;
            const pattern = /^[a-zA-Z0-9_-]*$/;
            
            if (!pattern.test(value)) {
                input.setCustomValidity('Only letters, numbers, hyphens (-), and underscores (_) are allowed. No spaces.');
                input.classList.add('is-invalid');
            } else {
                input.setCustomValidity('');
                input.classList.remove('is-invalid');
            }
        }

        // Add validation to identifier fields when they are created
        function setupIdentifierValidation() {
            const datasetIdentifierInput = document.getElementById('edit-dataset-identifier');
            const dataElementIdentifierInput = document.getElementById('edit-data-element-identifier');
            
            if (datasetIdentifierInput) {
                datasetIdentifierInput.addEventListener('input', function() {
                    validateIdentifier(this);
                });
                datasetIdentifierInput.addEventListener('blur', function() {
                    validateIdentifier(this);
                });
            }
            
            if (dataElementIdentifierInput) {
                dataElementIdentifierInput.addEventListener('input', function() {
                    validateIdentifier(this);
                });
                dataElementIdentifierInput.addEventListener('blur', function() {
                    validateIdentifier(this);
                });
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing D3.js visualization');
            
            try {
                // Check if D3 is loaded
                if (typeof d3 === 'undefined') {
                    console.error('D3.js library not loaded!');
                    return;
                }
                
                console.log('D3.js library loaded ✓');
                
                // Check if container exists
                const container = document.getElementById('graph-container');
                if (!container) {
                    console.error('Graph container not found!');
                    return;
                }
                
                console.log('Graph container found ✓');
                
                // Initialize the D3.js visualization
                try {
                    // Make sure the function is available
                    if (typeof window.initializeD3Visualization === 'function') {
                        window.initializeD3Visualization('graph-container');
                        console.log('D3 visualization initialized ✓');
                    } else {
                        console.error('D3 initialization function not found. Waiting...');
                        // Try again after a short delay to ensure scripts are loaded
                        setTimeout(() => {
                            if (typeof window.initializeD3Visualization === 'function') {
                                window.initializeD3Visualization('graph-container');
                                console.log('D3 visualization initialized after delay ✓');
                                // Also load the graph data if initialization succeeds
                                try {
                                    window.loadGraphWithD3();
                                } catch (graphErr) {
                                    console.error('Error loading graph after delay:', graphErr);
                                }
                            } else {
                                console.error('D3 initialization function still not found after delay');
                            }
                        }, 500);
                    }
                } catch (err) {
                    console.error('Error initializing D3:', err);
                    return;
                }
                
                // Load graph data
                try {
                    if (typeof window.loadGraphWithD3 === 'function') {
                        window.loadGraphWithD3();
                        console.log('Graph data loading started ✓');
                    } else {
                        console.error('loadGraphWithD3 function not found');
                    }
                } catch (err) {
                    console.error('Error loading graph:', err);
                    return;
                }
                
                // Initialize right sidebar
                clearNodeSelection();
                console.log('Initialization complete ✓');
            } catch (err) {
                console.error('Error during initialization:', err);
            }
        });

        function clearNodeSelection() {
            selectedNodeId = null;
            window.selectedNodeId = selectedNodeId;  // Update global reference
            selectedEdgeId = null;
            document.getElementById('selected-node-section').style.display = 'none';
            document.getElementById('selected-edge-section').style.display = 'none';
            document.getElementById('no-node-selected').style.display = 'block';
            document.getElementById('detach-btn').style.display = 'none';
            document.getElementById('edge-status').style.display = 'none';
        }

        function selectNode(nodeId) {
            selectedNodeId = nodeId;
            selectedEdgeId = null;  // Clear edge selection
            
            // Hide edge-related UI
            document.getElementById('detach-btn').style.display = 'none';
            document.getElementById('edge-status').style.display = 'none';
            
            // Update selection on server
            fetch(`/api/nodes/${nodeId}/select`, {
                method: 'POST'
            })
            .then(() => {
                loadNodeDetails(nodeId);
            });
        }

        function selectEdge(edgeId) {
            selectedNodeId = null;  // Clear node selection
            window.selectedNodeId = selectedNodeId;  // Update global reference
            selectedEdgeId = edgeId;
            
            // Hide node-related UI
            document.getElementById('selected-node-section').style.display = 'none';
            document.getElementById('no-node-selected').style.display = 'none';
            
            // Show edge-related UI
            document.getElementById('selected-edge-section').style.display = 'block';
            document.getElementById('detach-btn').style.display = 'block';
            document.getElementById('edge-status').style.display = 'block';
            
            // Load edge details
            loadEdgeDetails(edgeId);
            
            console.log('Edge selected:', edgeId);
        }

        function loadNodeDetails(nodeId) {
            console.log('Loading node details for:', nodeId);
            fetch(`/api/nodes/${nodeId}`)
                .then(response => response.json())
                .then(node => {
                    console.log('Received node data:', node);
                    
                    // Show right sidebar and hide placeholder
                    document.getElementById('selected-node-section').style.display = 'block';
                    document.getElementById('no-node-selected').style.display = 'none';

                    // The rest of the loadNodeDetails function remains the same as in the original file
                    // with all the logic for handling different node types
                    // ...

                    // Truncate description to first 50 words
                    let description = getLanguageText(node.description, 'de') || getLanguageText(node.description, 'en') || getLanguageText(node.description, 'fr') || getLanguageText(node.description, 'it') || 'None';
                    const words = description.split(/\s+/);
                    if (words.length > 50) {
                        description = words.slice(0, 50).join(' ') + '...';
                    }

                    // Prepare I14Y link if available
                    let i14yLink = '';
                    if (node.i14y_id) {
                        if (node.type === 'concept') {
                            i14yLink = `<strong>I14Y:</strong> <a href="https://www.i14y.admin.ch/de/catalog/concepts/${node.i14y_id}/description" target="_blank" rel="noopener">View full concept description</a><br>`;
                        } else if (node.type === 'dataset') {
                            i14yLink = `<strong>I14Y:</strong> <a href="https://www.i14y.admin.ch/de/catalog/datasets/${node.i14y_id}/description" target="_blank" rel="noopener">View full dataset description</a><br>`;
                        }
                    }

                    // Publisher info if available (from i14y_data)
                    let publisher = '';
                    if (node.i14y_data && node.i14y_data.publisherName) {
                        const pub = node.i14y_data.publisherName;
                        if (typeof pub === 'object') {
                            publisher = pub.de || pub.en || pub.fr || pub.it || pub.rm || '';
                        } else {
                            publisher = pub;
                        }
                        if (publisher) {
                            publisher = `<strong>Publisher:</strong> ${publisher}<br>`;
                        } else {
                            publisher = '';
                        }
                    }

                    // Update node information - check if it's a dataset node
                    let mainInfo;
                    if (node.type === 'dataset') {
                        // For dataset nodes, show editable fields
                        let i14yDatasetInfo = '';
                        if (node.i14y_dataset_uri) {
                            i14yDatasetInfo = `
                            <div class="mb-3 mt-2">
                                <p class="small text-success">✓ Linked to I14Y Dataset</p>
                                <a href="${node.i14y_dataset_uri}" target="_blank" class="btn btn-sm btn-outline-success w-100 mb-2">
                                    View on I14Y
                                </a>
                                <button class="btn btn-outline-danger btn-sm w-100" onclick="disconnectI14YDataset()">Disconnect Dataset</button>
                            </div>
                            `;
                        }
                        
                        // Check if dataset is linked to I14Y to determine if fields should be editable
                        const isLinked = !!node.i14y_dataset_uri;
                        
                        mainInfo = `
                            <strong>Type:</strong> ${node.type}<br>
                            <div class="mb-3 mt-3">
                                <label class="form-label small">Title:</label>
                                <ul class="nav nav-tabs" id="dataset-title-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="dataset-de-title-tab" data-bs-toggle="tab" data-bs-target="#dataset-de-title" type="button" role="tab" aria-controls="dataset-de-title" aria-selected="true">DE</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-fr-title-tab" data-bs-toggle="tab" data-bs-target="#dataset-fr-title" type="button" role="tab" aria-controls="dataset-fr-title" aria-selected="false">FR</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-it-title-tab" data-bs-toggle="tab" data-bs-target="#dataset-it-title" type="button" role="tab" aria-controls="dataset-it-title" aria-selected="false">IT</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-en-title-tab" data-bs-toggle="tab" data-bs-target="#dataset-en-title" type="button" role="tab" aria-controls="dataset-en-title" aria-selected="false">EN</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="dataset-title-tab-content">
                                    <div class="tab-pane fade show active" id="dataset-de-title" role="tabpanel" aria-labelledby="dataset-de-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-dataset-title-de" value="${escapeHtml(getLanguageText(node.title, 'de'))}" ${isLinked ? 'readonly' : ''} placeholder="German title">
                                    </div>
                                    <div class="tab-pane fade" id="dataset-fr-title" role="tabpanel" aria-labelledby="dataset-fr-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-dataset-title-fr" value="${escapeHtml(getLanguageText(node.title, 'fr'))}" ${isLinked ? 'readonly' : ''} placeholder="French title">
                                    </div>
                                    <div class="tab-pane fade" id="dataset-it-title" role="tabpanel" aria-labelledby="dataset-it-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-dataset-title-it" value="${escapeHtml(getLanguageText(node.title, 'it'))}" ${isLinked ? 'readonly' : ''} placeholder="Italian title">
                                    </div>
                                    <div class="tab-pane fade" id="dataset-en-title" role="tabpanel" aria-labelledby="dataset-en-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-dataset-title-en" value="${escapeHtml(getLanguageText(node.title, 'en'))}" ${isLinked ? 'readonly' : ''} placeholder="English title">
                                    </div>
                                </div>
                                ${isLinked ? '<small class="text-muted">Title is managed by I14Y</small>' : ''}
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Description:</label>
                                <ul class="nav nav-tabs" id="dataset-description-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="dataset-de-desc-tab" data-bs-toggle="tab" data-bs-target="#dataset-de-description" type="button" role="tab" aria-controls="dataset-de-description" aria-selected="true">DE</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-fr-desc-tab" data-bs-toggle="tab" data-bs-target="#dataset-fr-description" type="button" role="tab" aria-controls="dataset-fr-description" aria-selected="false">FR</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-it-desc-tab" data-bs-toggle="tab" data-bs-target="#dataset-it-description" type="button" role="tab" aria-controls="dataset-it-description" aria-selected="false">IT</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dataset-en-desc-tab" data-bs-toggle="tab" data-bs-target="#dataset-en-description" type="button" role="tab" aria-controls="dataset-en-description" aria-selected="false">EN</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="dataset-description-tab-content">
                                    <div class="tab-pane fade show active" id="dataset-de-description" role="tabpanel" aria-labelledby="dataset-de-desc-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-dataset-description-de" rows="3" ${isLinked ? 'readonly' : ''} placeholder="German description">${escapeHtml(getLanguageText(node.description, 'de'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="dataset-fr-description" role="tabpanel" aria-labelledby="dataset-fr-desc-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-dataset-description-fr" rows="3" ${isLinked ? 'readonly' : ''} placeholder="French description">${escapeHtml(getLanguageText(node.description, 'fr'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="dataset-it-description" role="tabpanel" aria-labelledby="dataset-it-desc-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-dataset-description-it" rows="3" ${isLinked ? 'readonly' : ''} placeholder="Italian description">${escapeHtml(getLanguageText(node.description, 'it'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="dataset-en-description" role="tabpanel" aria-labelledby="dataset-en-desc-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-dataset-description-en" rows="3" ${isLinked ? 'readonly' : ''} placeholder="English description">${escapeHtml(getLanguageText(node.description, 'en'))}</textarea>
                                    </div>
                                </div>
                                ${isLinked ? '<small class="text-muted">Description is managed on I14Y</small>' : ''}
                            </div>
                            <div class="mb-3">
                                <label for="edit-dataset-identifier" class="form-label small">Identifier:</label>
                                <input type="text" class="form-control form-control-sm" id="edit-dataset-identifier" value="${escapeHtml(node.identifier || '')}" ${isLinked ? 'readonly' : ''} placeholder="Dataset identifier" pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, hyphens (-), and underscores (_) are allowed. No spaces.">
                                <div class="form-text">Unique identifier for this dataset (letters, numbers, hyphens, underscores only)</div>
                                ${isLinked ? '<small class="text-muted">Identifier is managed by I14Y</small>' : ''}
                            </div>
                            ${isLinked ? '' : '<button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="updateDatasetInfo()">Update Dataset</button>'}
                            ${node.i14y_dataset_uri ? '' : '<button class="btn btn-dataset btn-sm w-100 mb-2" onclick="showI14YDatasetSearchModal()">Link to I14Y Dataset</button>'}
                            ${i14yDatasetInfo}
                        `;
                    } else if (node.type === 'class') {
                        // Check if class is linked to I14Y (has i14y_id)
                        const isI14YLinked = !!node.i14y_id;
                        
                        // For class nodes, show editable fields if not linked to I14Y
                        let classEditableFields = '';
                        if (!isI14YLinked) {
                            classEditableFields = `
                                <div class="mb-3 mt-3">
                                    <label for="edit-node-title" class="form-label small">Title:</label>
                                    <input type="text" class="form-control form-control-sm" id="edit-node-title" value="${node.title}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Description (Multilingual):</label>
                                    <ul class="nav nav-tabs" id="class-edit-description-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="class-edit-de-tab" data-bs-toggle="tab" data-bs-target="#class-edit-de-description" type="button" role="tab" aria-controls="class-edit-de-description" aria-selected="true">DE</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="class-edit-fr-tab" data-bs-toggle="tab" data-bs-target="#class-edit-fr-description" type="button" role="tab" aria-controls="class-edit-fr-description" aria-selected="false">FR</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="class-edit-it-tab" data-bs-toggle="tab" data-bs-target="#class-edit-it-description" type="button" role="tab" aria-controls="class-edit-it-description" aria-selected="false">IT</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="class-edit-en-tab" data-bs-toggle="tab" data-bs-target="#class-edit-en-description" type="button" role="tab" aria-controls="class-edit-en-description" aria-selected="false">EN</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="class-edit-description-tab-content">
                                        <div class="tab-pane fade show active" id="class-edit-de-description" role="tabpanel" aria-labelledby="class-edit-de-tab">
                                            <textarea class="form-control form-control-sm mt-2" id="edit-class-description-de" rows="3" placeholder="German description">${escapeHtml(getLanguageText(node.description, 'de'))}</textarea>
                                        </div>
                                        <div class="tab-pane fade" id="class-edit-fr-description" role="tabpanel" aria-labelledby="class-edit-fr-tab">
                                            <textarea class="form-control form-control-sm mt-2" id="edit-class-description-fr" rows="3" placeholder="French description">${escapeHtml(getLanguageText(node.description, 'fr'))}</textarea>
                                        </div>
                                        <div class="tab-pane fade" id="class-edit-it-description" role="tabpanel" aria-labelledby="class-edit-it-tab">
                                            <textarea class="form-control form-control-sm mt-2" id="edit-class-description-it" rows="3" placeholder="Italian description">${escapeHtml(getLanguageText(node.description, 'it'))}</textarea>
                                        </div>
                                        <div class="tab-pane fade" id="class-edit-en-description" role="tabpanel" aria-labelledby="class-edit-en-tab">
                                            <textarea class="form-control form-control-sm mt-2" id="edit-class-description-en" rows="3" placeholder="English description">${escapeHtml(getLanguageText(node.description, 'en'))}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="updateNodeInfo()">Update ${node.type}</button>
                                <button class="btn btn-warning btn-sm w-100 mb-2" onclick="confirmConvertToDataset()">Convert to Dataset</button>
                            `;
                        } else {
                            classEditableFields = `
                                <strong>Title:</strong> ${node.title}<br>
                                <strong>Description:</strong> ${description}<br>
                                <small class="text-muted">This ${node.type} is linked to I14Y and cannot be edited locally.</small><br>
                                <button class="btn btn-warning btn-sm w-100 mb-2" onclick="confirmConvertToDataset()">Convert to Dataset</button>
                            `;
                        }
                        
                        mainInfo = `
                            <strong>Type:</strong> ${node.type}<br>
                            ${classEditableFields}
                            ${i14yLink}
                            ${publisher}
                        `;
                    } else if (node.type === 'data_element') {
                        // For data element nodes, show comprehensive information
                        console.log('Data element node data:', node);
                        
                        let conceptLinkInfo = '';
                        let conceptDetails = '';
                        
                        if (node.is_linked_to_concept && node.conforms_to_concept_uri) {
                            console.log('Data element is linked to concept:', node.conforms_to_concept_uri);
                            console.log('I14Y data available:', node.i14y_data);
                            
                            // Extract concept ID from URI for I14Y link
                            const conceptId = node.conforms_to_concept_uri.split('/').slice(-2, -1)[0];
                            
                            // Show concept information if available from i14y_data
                            if (node.i14y_data) {
                                const conceptTitle = getMultilingualText(node.i14y_data.title || node.i14y_data.name) || 'Unknown Concept';
                                const conceptPublisher = getMultilingualText(node.i14y_data.publisherName || node.i14y_data.publisher?.name) || 'Unknown Publisher';
                                const conceptDescription = getMultilingualText(node.i14y_data.description) || 'No description available';
                                const conceptType = node.i14y_data.conceptValueType || node.i14y_data.conceptType || '';
                                
                                // Truncate description if too long
                                let truncatedDescription = conceptDescription;
                                const words = conceptDescription.split(' ');
                                if (words.length > 20) {
                                    truncatedDescription = words.slice(0, 20).join(' ') + '...';
                                }
                                
                                // Build type line only if type is available
                                const typeInfo = conceptType ? `<strong>Type:</strong> ${escapeHtml(conceptType)}<br>` : '';
                                
                                conceptDetails = `
                                    <div class="mb-3 p-3 border rounded bg-light">
                                        <h6 class="text-primary mb-2">🔗 Linked I14Y Concept</h6>
                                        <strong>Title:</strong> ${escapeHtml(conceptTitle)}<br>
                                        ${typeInfo}
                                        <strong>Publisher:</strong> ${escapeHtml(conceptPublisher)}<br>
                                        <strong>Description:</strong> <span class="small text-muted">${escapeHtml(truncatedDescription)}</span><br>
                                        <strong>Concept ID:</strong> <code class="small">${escapeHtml(conceptId)}</code>
                                    </div>
                                `;
                            } else {
                                // Fallback when no i14y_data is available
                                conceptDetails = `
                                    <div class="mb-3 p-3 border rounded bg-light">
                                        <h6 class="text-primary mb-2">🔗 Linked I14Y Concept</h6>
                                        <strong>Concept ID:</strong> <code class="small">${escapeHtml(conceptId)}</code><br>
                                        <small class="text-muted">Concept details not available locally</small>
                                    </div>
                                `;
                            }
                            
                            conceptLinkInfo = `
                                <div class="mb-3">
                                    <div class="d-grid gap-2">
                                        <a href="${node.conforms_to_concept_uri}" target="_blank" class="btn btn-outline-success btn-sm">
                                            View on I14Y ↗
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm" onclick="unlinkDataElementFromConcept()">
                                            Detach from Concept
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            conceptLinkInfo = `
                                <div class="mb-3">
                                    <div class="d-grid">
                                        <button class="btn btn-concept btn-sm" onclick="showLinkDataElementToConceptModal()">
                                            Link to I14Y Concept
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Build comprehensive data element information
                        mainInfo = `
                            <strong>Type:</strong> Data Element<br><br>
                            ${conceptDetails}
                            <div class="mb-3 mt-3">
                                <label class="form-label small">Title (Multilingual):</label>
                                <ul class="nav nav-tabs" id="edit-data-element-title-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="edit-data-element-de-title-tab" data-bs-toggle="tab" data-bs-target="#edit-data-element-de-title" type="button" role="tab" aria-controls="edit-data-element-de-title" aria-selected="true">DE</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="edit-data-element-fr-title-tab" data-bs-toggle="tab" data-bs-target="#edit-data-element-fr-title" type="button" role="tab" aria-controls="edit-data-element-fr-title" aria-selected="false">FR</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="edit-data-element-it-title-tab" data-bs-toggle="tab" data-bs-target="#edit-data-element-it-title" type="button" role="tab" aria-controls="edit-data-element-it-title" aria-selected="false">IT</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="edit-data-element-en-title-tab" data-bs-toggle="tab" data-bs-target="#edit-data-element-en-title" type="button" role="tab" aria-controls="edit-data-element-en-title" aria-selected="false">EN</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="edit-data-element-title-tab-content">
                                    <div class="tab-pane fade show active" id="edit-data-element-de-title" role="tabpanel" aria-labelledby="edit-data-element-de-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-data-element-title-de" value="${escapeHtml(getLanguageText(node.title, 'de'))}" placeholder="German title">
                                    </div>
                                    <div class="tab-pane fade" id="edit-data-element-fr-title" role="tabpanel" aria-labelledby="edit-data-element-fr-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-data-element-title-fr" value="${escapeHtml(getLanguageText(node.title, 'fr'))}" placeholder="French title">
                                    </div>
                                    <div class="tab-pane fade" id="edit-data-element-it-title" role="tabpanel" aria-labelledby="edit-data-element-it-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-data-element-title-it" value="${escapeHtml(getLanguageText(node.title, 'it'))}" placeholder="Italian title">
                                    </div>
                                    <div class="tab-pane fade" id="edit-data-element-en-title" role="tabpanel" aria-labelledby="edit-data-element-en-title-tab">
                                        <input type="text" class="form-control form-control-sm mt-2" id="edit-data-element-title-en" value="${escapeHtml(getLanguageText(node.title, 'en'))}" placeholder="English title">
                                    </div>
                                </div>
                                <div class="form-text">Title used for this data element in different languages</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Description:</label>
                                <ul class="nav nav-tabs" id="description-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="de-tab" data-bs-toggle="tab" data-bs-target="#de-description" type="button" role="tab" aria-controls="de-description" aria-selected="true">DE</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="fr-tab" data-bs-toggle="tab" data-bs-target="#fr-description" type="button" role="tab" aria-controls="fr-description" aria-selected="false">FR</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="it-tab" data-bs-toggle="tab" data-bs-target="#it-description" type="button" role="tab" aria-controls="it-description" aria-selected="false">IT</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="en-tab" data-bs-toggle="tab" data-bs-target="#en-description" type="button" role="tab" aria-controls="en-description" aria-selected="false">EN</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="description-tab-content">
                                    <div class="tab-pane fade show active" id="de-description" role="tabpanel" aria-labelledby="de-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-data-element-description-de" rows="3" placeholder="German description">${escapeHtml(getLanguageText(node.description, 'de'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="fr-description" role="tabpanel" aria-labelledby="fr-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-data-element-description-fr" rows="3" placeholder="French description">${escapeHtml(getLanguageText(node.description, 'fr'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="it-description" role="tabpanel" aria-labelledby="it-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-data-element-description-it" rows="3" placeholder="Italian description">${escapeHtml(getLanguageText(node.description, 'it'))}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="en-description" role="tabpanel" aria-labelledby="en-tab">
                                        <textarea class="form-control form-control-sm mt-2" id="edit-data-element-description-en" rows="3" placeholder="English description">${escapeHtml(getLanguageText(node.description, 'en'))}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="edit-data-element-identifier" class="form-label small">Identifier:</label>
                                <input type="text" class="form-control form-control-sm" id="edit-data-element-identifier" value="${escapeHtml(node.identifier || '')}" placeholder="Data element identifier" pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, hyphens (-), and underscores (_) are allowed. No spaces.">
                                <div class="form-text">Unique identifier for this data element (letters, numbers, hyphens, underscores only)</div>
                            </div>
                            <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="updateDataElementInfo()">Update Data Element</button>
                            ${conceptLinkInfo}
                        `;
                    } else {
                        // For concept nodes, show editable fields if not linked to I14Y
                        const isI14YLinked = !!node.i14y_id;
                        
                        if (!isI14YLinked) {
                            mainInfo = `
                                <strong>Type:</strong> ${node.type}<br>
                                <div class="mb-3 mt-3">
                                    <label for="edit-node-title" class="form-label small">Title:</label>
                                    <input type="text" class="form-control form-control-sm" id="edit-node-title" value="${node.title}">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-node-description" class="form-label small">Description:</label>
                                    <textarea class="form-control form-control-sm" id="edit-node-description" rows="3">${getLanguageText(node.description, 'de') || getLanguageText(node.description, 'en') || ''}</textarea>
                                </div>
                                <button class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="updateNodeInfo()">Update ${node.type}</button>
                                <button class="btn btn-concept btn-sm w-100 mb-2" onclick="showLinkToI14YModal()">Link to I14Y Concept</button>
                                ${i14yLink}
                                ${publisher}
                            `;
                        } else {
                            // Prepare I14Y concept view link
                            let i14yConceptButtons = '';
                            if (node.i14y_id) {
                                const conceptViewUrl = `https://www.i14y.admin.ch/de/catalog/concepts/${node.i14y_id}/description`;
                                i14yConceptButtons = `
                                <div class="mb-3 mt-2">
                                    <p class="small text-success">✓ Linked to I14Y Concept</p>
                                    <a href="${conceptViewUrl}" target="_blank" class="btn btn-sm btn-outline-success w-100 mb-2">
                                        View on I14Y
                                    </a>
                                    <button class="btn btn-outline-danger btn-sm w-100" onclick="disconnectI14YConcept()">Disconnect from I14Y</button>
                                </div>
                                `;
                            }
                            
                            mainInfo = `
                                <strong>Type:</strong> ${node.type}<br>
                                <strong>Title:</strong> ${node.title}<br>
                                <strong>Description:</strong> ${description}<br>
                                <small class="text-muted">This ${node.type} is linked to I14Y and cannot be edited locally.</small><br>
                                ${i14yConceptButtons}
                                ${publisher}
                            `;
                        }
                    }
                    document.getElementById('selected-node-info').innerHTML = mainInfo;

                    // Setup identifier validation for the newly created input fields
                    setTimeout(setupIdentifierValidation, 100);

                    // Show or hide order section for data elements
                    const orderSection = document.getElementById('order-section');
                    const orderInput = document.getElementById('element-order');
                    if (node.type === 'data_element') {
                        if (orderSection) {
                            orderSection.style.display = 'block';
                        }
                        if (orderInput) {
                            const orderValue = node.order !== null && node.order !== undefined ? node.order : '';
                            console.log('Setting order field value:', orderValue, 'from node.order:', node.order);
                            orderInput.value = orderValue;
                        }
                    } else {
                        if (orderSection) orderSection.style.display = 'none';
                        if (orderInput) orderInput.value = '';
                    }

                    // Show or hide constraints section based on node type
                    const constraintsSection = document.getElementById('constraints-section');
                    if (node.type === 'dataset' || 
                        node.type === 'class' || 
                        (node.type === 'data_element' && node.conforms_to_concept_uri)) {
                        // Hide constraints for dataset nodes, class nodes, and data elements with conformsTo link
                        if (constraintsSection) constraintsSection.style.display = 'none';
                    } else {
                        // Show constraints only for standalone data elements and concepts
                        if (constraintsSection) constraintsSection.style.display = 'block';
                        
                        // Show/hide constraint groups based on node type
                        if (node.type === 'class') {
                            // For classes, show all but length constraints
                            document.getElementById('length-group').style.display = 'none';
                            document.getElementById('pattern-group').style.display = 'block';
                            document.getElementById('enumeration-group').style.display = 'block';
                            document.getElementById('references-group').style.display = 'block';
                            document.getElementById('datatype-field').style.display = 'none'; // Hide datatype for classes
                        } else {
                            // For concepts, show all constraint groups
                            document.getElementById('length-group').style.display = 'block';
                            document.getElementById('pattern-group').style.display = 'block';
                            document.getElementById('enumeration-group').style.display = 'block';
                            document.getElementById('references-group').style.display = 'block';
                            document.getElementById('datatype-field').style.display = 'block';
                        }
                        
                        // Update constraint fields
                        document.getElementById('min-length').value = node.min_length || '';
                        document.getElementById('max-length').value = node.max_length || '';
                        document.getElementById('pattern').value = node.pattern || '';
                        document.getElementById('in-values').value = node.in_values ? node.in_values.join(', ') : '';
                        document.getElementById('node-reference').value = node.node_reference || '';
                        document.getElementById('range').value = node.range || '';
                        document.getElementById('datatype').value = node.datatype || '';
                        
                        // Show I14Y constraints notification if this is an I14Y concept with constraints
                        const hasI14YConstraints = node.i14y_id && (node.pattern || (node.in_values && node.in_values.length > 0) || node.min_length || node.max_length || node.datatype);
                        const constraintsInfo = document.getElementById('i14y-constraints-info');
                        if (hasI14YConstraints) {
                            constraintsInfo.style.display = 'block';
                        } else {
                            constraintsInfo.style.display = 'none';
                        }
                    }
                });
        }

        // Make loadNodeDetails globally accessible
        window.loadNodeDetails = loadNodeDetails;

        function loadEdgeDetails(edgeId) {
            // Load edge information
            fetch(`/api/edges/${edgeId}`)
                .then(response => response.json())
                .then(edge => {
                    // Show connection information
                    const fromNode = edge.from_node || { title: 'Unknown', type: 'unknown' };
                    const toNode = edge.to_node || { title: 'Unknown', type: 'unknown' };
                    
                    let fromTitle = typeof fromNode.title === 'object' ? getMultilingualText(fromNode.title) : fromNode.title;
                    let toTitle = typeof toNode.title === 'object' ? getMultilingualText(toNode.title) : toNode.title;
                    
                    document.getElementById('selected-edge-info').innerHTML = `
                        <strong>Connection:</strong><br>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">${fromNode.type}</span>
                                <span><i class="bi bi-arrow-right"></i></span>
                                <span class="badge bg-secondary">${toNode.type}</span>
                            </div>
                            <div class="mt-2">
                                <strong>From:</strong> ${fromTitle}<br>
                                <strong>To:</strong> ${toTitle}
                            </div>
                        </div>
                    `;

                    // Set cardinality in dropdown
                    const cardinalitySelect = document.getElementById('edge-cardinality');
                    let cardinality = edge.cardinality || '1..1';
                    
                    // Check if this is a standard cardinality
                    const standardCardinalities = ['0..1', '1..1', '0..n', '1..n', '0..0'];
                    if (standardCardinalities.includes(cardinality)) {
                        cardinalitySelect.value = cardinality;
                        document.getElementById('custom-cardinality-section').style.display = 'none';
                    } else {
                        // Must be a custom cardinality
                        cardinalitySelect.value = '2..5'; // Select custom option
                        document.getElementById('custom-cardinality').value = cardinality;
                        document.getElementById('custom-cardinality-section').style.display = 'block';
                    }

                    // Add event listener for cardinality change
                    cardinalitySelect.onchange = function() {
                        if (this.value === '2..5') {
                            document.getElementById('custom-cardinality-section').style.display = 'block';
                        } else {
                            document.getElementById('custom-cardinality-section').style.display = 'none';
                        }
                    };
                });
        }

        // Connect existing application functions to the new UML visualization
        window.selectNode = selectNode;
        window.selectEdge = selectEdge;
        window.clearNodeSelection = clearNodeSelection;
        window.selectedNodeId = selectedNodeId;
        
        // Other application functions (add, remove, etc.) remain the same
        // ...

        // Include functions for edge cardinality and other operations
        function applyEdgeCardinality() {
            if (!selectedEdgeId) {
                alert('No connection selected');
                return;
            }

            let cardinality;
            const cardinalitySelect = document.getElementById('edge-cardinality');
            
            if (cardinalitySelect.value === '2..5') {
                // Custom cardinality
                cardinality = document.getElementById('custom-cardinality').value;
                if (!cardinality.match(/^\d+\.\.\d+$/) && !cardinality.match(/^\d+\.\.\*$/)) {
                    alert('Invalid cardinality format. Please use format like "2..10" or "5..*"');
                    return;
                }
            } else {
                cardinality = cardinalitySelect.value;
            }

            fetch(`/api/edges/${selectedEdgeId}/cardinality`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cardinality: cardinality })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadGraph();
                    loadEdgeDetails(selectedEdgeId);
                } else {
                    alert('Error updating cardinality');
                }
            });
        }
        
        function clearEdgeSelection() {
            selectedEdgeId = null;
            document.getElementById('selected-edge-section').style.display = 'none';
            document.getElementById('detach-btn').style.display = 'none';
            document.getElementById('edge-status').style.display = 'none';
            document.getElementById('no-node-selected').style.display = 'block';
        }
        
        // Make clearEdgeSelection globally accessible
        window.clearEdgeSelection = clearEdgeSelection;
        
        // Include the rest of the application functions...
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- D3.js visualization -->
    <script src="/static/js/network-d3.js"></script>
    
    <!-- Tree visualization -->
    <script src="/static/js/xml-tree.js"></script>
    
    <!-- Modal handlers for add class and add data element -->
    <script src="/static/js/modal-handlers.js"></script>
    
    <!-- Import handlers for CSV and XSD import -->
    <script src="/static/js/import-handlers.js"></script>
</body>
</html>
